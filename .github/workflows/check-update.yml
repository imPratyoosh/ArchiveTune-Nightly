name: Check for Updates

on:
  repository_dispatch:
    types: [check-for-update]

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get current SHA from history
        run: |
          SHA=$(jq -r '.commit.sha' history/commit.json)
          echo "CURRENT_SHA=$SHA" >> $GITHUB_ENV

      - name: Get latest commit info from upstream
        run: |
          RESPONSE=$(curl -s https://api.github.com/repos/koiverse/ArchiveTune/commits/dev)
          LATEST_SHA=$(echo $RESPONSE | jq -r '.sha')
          MESSAGE=$(echo $RESPONSE | jq -r '.commit.message')
          echo "LATEST_SHA=$LATEST_SHA" >> $GITHUB_ENV
          echo "MESSAGE=$MESSAGE" >> $GITHUB_ENV

      - name: Compare SHAs
        run: |
          if [ "$CURRENT_SHA" == "$LATEST_SHA" ]; then
            echo "No update, skipping"
            echo "SKIP=true" >> $GITHUB_ENV
          else
            echo "Update available, triggering build"
            echo "SKIP=false" >> $GITHUB_ENV
          fi

      - name: Trigger nightly build
        if: env.SKIP == 'false'
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "trigger-nightly"}'