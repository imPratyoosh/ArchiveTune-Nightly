name: Nightly Build

on:
  repository_dispatch:
    types: [trigger-nightly]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# ===============================
# 1️⃣ PREPARE (single-source data)
# ===============================
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      new_version_code: ${{ steps.version.outputs.new_version_code }}
      date: ${{ steps.date.outputs.date }}
      time: ${{ steps.time.outputs.time }}

    steps:
      - name: Generate version
        id: version
        run: |
          NEW_VERSION="N$(date +%Y%m%d)"
          NEW_VERSION_CODE="${GITHUB_RUN_NUMBER}"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_version_code=$NEW_VERSION_CODE" >> $GITHUB_OUTPUT

      - name: Get Date
        id: date
        run: echo "date=$(date +'%Y/%m/%d')" >> $GITHUB_OUTPUT

      - name: Get Time
        id: time
        run: echo "time=$(date +'%I:%M:%S %p')" >> $GITHUB_OUTPUT


# ===============================
# 2️⃣ BUILD (matrix, parallel)
# ===============================
  build:
    needs: prepare
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        abi: [arm64, armeabi, x86, x86_64, universal]

    steps:
      - uses: actions/checkout@v4
        with:
          repository: koiverse/ArchiveTune
          ref: dev

      - name: Generate changelog
        run: |
          git log \
            --pretty=format="- ([%h](https://github.com/koiverse/ArchiveTune/commit/%H)): **\"%s\"** by **@%an**" \
            --since="24 hours ago" \
            --no-merges > CHANGELOG.md || true

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-cleanup: on-success

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ---------------------------
      # SAFE VERSION UPDATE
      # ---------------------------
      - name: Update version for nightly
        run: |
          sed -i \
            "s/versionName = \".*\"/versionName = \"${{ needs.prepare.outputs.new_version }}\"/" \
            app/build.gradle.kts

          sed -i \
            "s/versionCode = .*/versionCode = ${{ needs.prepare.outputs.new_version_code }}/" \
            app/build.gradle.kts

      # ---------------------------
      # SAFE BRANDING CHANGES
      # ---------------------------
      - name: Update package & app name
        run: |
          sed -i \
            's/applicationId = "moe.koiverse.archivetune"/applicationId = "moe.koiverse.archivetune.nightly"/' \
            app/build.gradle.kts

          sed -i \
            's/ArchiveTune Debug/ArchiveTune Nightly Debug/' \
            app/src/debug/res/values/app_name.xml

      # ---------------------------
      # SAFE DEFAULT CHANNEL CHANGE
      # ---------------------------
      - name: Set default update channel to nightly
        run: |
          sed -i \
            's/defaultValue = UpdateChannel.STABLE/defaultValue = UpdateChannel.NIGHTLY/' \
            app/src/main/kotlin/moe/koiverse/archivetune/ui/screens/settings/UpdateScreen.kt

      # ---------------------------
      # UPDATER URL FIXES
      # ---------------------------
      - name: Update updater URLs
        run: |
          sed -i \
            's|https://api.github.com/repos/koiverse/ArchiveTune|https://api.github.com/repos/sang765/ArchiveTune-Nightly|g' \
            app/src/main/kotlin/moe/koiverse/archivetune/utils/Updater.kt

          sed -i \
            's|https://github.com/koiverse/ArchiveTune|https://github.com/sang765/ArchiveTune-Nightly|g' \
            app/src/main/kotlin/moe/koiverse/archivetune/utils/Updater.kt

      # ---------------------------
      # BUILD
      # ---------------------------
      - name: Build APK
        run: ./gradlew assemble${{ matrix.abi }}Release
        env:
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          LASTFM_SECRET: ${{ secrets.LASTFM_SECRET }}

      # ---------------------------
      # SIGN
      # ---------------------------
      - name: Sign APK
        uses: ilharp/sign-android-release@v2
        with:
          releaseDir: app/build/outputs/apk/${{ matrix.abi }}/release
          signingKey: ${{ secrets.SIGNING_KEY_BASE64 }}
          keyAlias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}

      # ---------------------------
      # UPLOAD
      # ---------------------------
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.abi }}-nightly
          path: app/build/outputs/apk/${{ matrix.abi }}/release/*.apk


# ===============================
# 3️⃣ RELEASE
# ===============================
  create-release:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          repository: imPratyoosh/ArchiveTune-Nightly
          ref: main

      - name: Download APKs
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create nightly release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.new_version }}
          name: ${{ needs.prepare.outputs.new_version }}
          body: |
            **ArchiveTune Nightly**

            Generated on **${{ needs.prepare.outputs.date }} – ${{ needs.prepare.outputs.time }} (UTC)**

            Changelog:
            https://github.com/koiverse/ArchiveTune/commits/dev
          files: artifacts/**/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}